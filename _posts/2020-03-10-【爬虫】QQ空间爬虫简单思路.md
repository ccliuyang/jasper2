---
layout: post
current: post
cover:  spider.jpg
navigation: True
title: 【爬虫】QQ空间爬虫简单思路
date: 2020-03-10 11:33:00
tags: [spider, python, dev]
class: post-template
subclass: 'post spider, python, dev'
author: dexfire
comment: True
---

# 【爬虫】QQ空间爬虫简单思路

我们继续尝试爬取QQ空间的好友动态。现在是大数据当道的时代，爬虫工程师也成了一个关键性的抢手职位，你可以不做一个优秀的爬虫工程师，但掌握一门扎实的爬虫编写技能，是可以为你的职业技能加分的。同时

## 展开全文：读取完整的说说 feed 内容

QQ 空间说说常见如图所示的展开全文选项，那么怎样实现一次性爬取完整说说内容呢？

单条说说的html层级结构：
![p-1](/assets/images/QQ截图20200312110802.png)

- ul > [data-page='5']
  - li > f-single f-s-s
    - div > f-single-head f-aside
    - div > f-single-content f-wrap
      - div > f-item f-s-i
          - div > f-info qz_info_cut none
          - div > f-info qz_info_complete
          - div > qz_summary wupfeed
    - div > f-single-foot
- ul > [data-page='6']
![p0](/assets/images/QQ截图20200311232102.png)

读取完整 Feed 内容，这里可以使用 浏览器调试工具中的 Elements -> Event Listener
可以读取并定位 js 调用堆栈，达到监视 js 运行的目的。

![p1](/assets/images/QQ截图20200311231857.png)

我们追踪一次看看：

![p3](/assets/images/QQ截图20200311232244.png)

发现其中在777行：

![p4](/assets/images/QQ截图20200312000407.png)

```js
 for (var n in a) {
    if (a.hasOwnProperty(n)) {
        $j(e).delegate(n, "click", function(e) {
            var n = $j(this);
            var r = QZONE.Feeds.queryFeedByElem(this);
            if (!r) {
                return
            }
            var o = new _(r,r.container.getFeedIndex(r));
            var s = a[e.handleObj.selector];
            if (e.handleObj.selector == '[data-clicklog="ignore"]') {
                return
            }
            if (e.handleObj.selector == "[data-clicklog]") {
                if (!n.attr("data-clicklog") || a['[data-clicklog="' + n.attr("data-clicklog") + '"]']) {
                    return
                } else {
                    s.pingType = n.attr("data-clicklog")
                }
            }
            if (s.callback) {
                if (!s.callback(this, o)) {
                    return
                }
            }
            o.setDatas(s);
            if (!t[i(o)]) {
                return
            }
            if (h) {
                if (s.flush) {
                    h.flushFeedDataList(o)
                } else {
                    h.addFeedDataList(o)
                }
                h.pingGDClick(o)
            }
        })
    }
}
```

调用了一个`var r = QZONE.Feeds.queryFeedByElem(this);` 函数，而这个疑似就是获取Feed的最终函数，查找定义为：
```js
function(require, e) {
    var t = jQuery;
    t = e.$e.find('a[data-cmd="qz_popup"][data-version="3"]')
    a = $j(t[0]),
    var I = parseInt(a.attr("data-newplayer"));
    # feeds_core.js line 1548
    QZONE.Feeds.queryFeedByElem = function(e) {
        if (!e || !e.nodeType) return;
        var i;
        if (t(e).hasClass("f-s-s")) {
            i = e
        } else {
            i = t(e).parents(".f-s-s").get(0)
        }
        if (i) {
            var a = t(i).data("__cuid__");
            var n = I[a];
            if (n) return n.getFeedByElem(i)
        }
    };
}

# feeds_core line 929
function k(e, a) {
    this.feeds = [];
    this.elem = e;
    this.cid = e.id;
    this.sortsession = (new Date).getTime();
    t.extend(this, a);
    C.init(e, this);
    i.bindClicklog(this.elem);
    i.updateSession(this.sortsession);
    if (QZONE.ICFeeds.VideoManager) {
        QZONE.ICFeeds.VideoManager.reset()
    }
}

# feeds_core line 980
k.prototype.getFeedByElem = function(e) {
    if (!e) return null;
    for (var t = 0; this.feeds[t]; t++) {
        if (this.feeds[t].elem == e) return this.feeds[t]
    }
};

k.prototype.appendFeedsData = function(e) {
    if (!$j.isArray(e)) return;
    var t, i;
    for (i = 0; e[i]; i++) {
        t = e[i];
        this.addNewFeed(t.node, t.data)
    }
};
k.prototype.addNewFeed = function(e, t) {
    if (!e || !t) {
        return
    }
    var a = new w(e, t, this);
    a.$e.data("__cuid__", this.cuid);
    this.feeds.push(a);
    i.addFeedsToPool([[a, this.getFeedIndex(a)]]);
    return a
};

k.prototype.getFeedByElem = function(e) {
    if (!e) return null;
    for (var t = 0; this.feeds[t]; t++) {
        if (this.feeds[t].elem == e) return this.feeds[t]
    }
};
k.prototype.removeFeedsByUin = function(e) {
    if (!e) return;
    var t, i = this.feeds.length - 1;
    for (; this.feeds[i]; i--) {
        t = this.feeds[i];
        if (t.data.opuin == e) {
            this.feeds.splice(i, 1);
            t._clear(true)
        }
    }
};

# feed.js line 77
function initFirstPageFeeds(opts) {
var currentContainer, _csfeedsData;
opts = opts || {};
var qzlog = QZONE.consoleFM;
qzlog.log({cm:"feeds", cf:"initFirstPageFeeds", w:{"sence":opts.sence}});
if (opts.sence == "home_personal") {
    opts.req_sence = "home";
    currentContainer = FeedsCore.getHomeFeedsContainer(opts);
    currentContainer.initFirstPage(opts.feedsData);
} else {
    if (opts.sence == "famous_feeds") {
    opts.req_sence = "ic";
    FeedsCore.getFamousFeedsContainer(opts);
    } else {
    opts.req_sence = opts.sence = "ic";
    _csfeedsData = {};
    $j.each(g_Data.feedsPart1, function(key, val) {
        _csfeedsData[key] = val;
    });
    $j.each(g_Data.feedsPart2, function(key, val) {
        _csfeedsData[key] = val;
    });
    if (G_Param.scope == 1 || g_Data.feeds.type == "") {
        currentContainer = FeedsCore.getHostFeedsContainer(opts);
        currentContainer.initFirstPage(_csfeedsData);
    }
    if (G_Param.scope == 7) {
        FeedsCore.getCareFeedsContainer(opts);
    } else {
        currentContainer = FeedsCore.getFriendFeedsContainer(opts);
        currentContainer.initFirstPage(_csfeedsData);
        cpujs.load(function() {
        require.async("v8/ic/hotfeeds", function(M) {
            M.showHotFeed();
        });
        });
    }
    }
}
}
exports.onNewFeedsRender = function(datas) {
var feedsContainer = getFeedsCurrent();
if ($j.isArray(datas) && datas.length) {
    feedsContainer.appendFeedsData(datas);
}
QZONE && (QZONE.qzEvent && QZONE.qzEvent.dispatch("QZ_ON_NEW_FEEDS_RENDER", {feedsData:datas}));
};

```
